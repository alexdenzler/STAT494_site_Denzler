---
title: "Assignment #2"
output: 
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    code_download: true
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

```{r libraries}
library(tidyverse)         # for graphing and data cleaning
library(tidymodels)        # for modeling
library(stacks)            # for stacking models
library(naniar)            # for analyzing missing values
library(lubridate)         # for date manipulation
library(moderndive)        # for King County housing data
library(vip)               # for variable importance plots
library(DALEX)             # for model interpretation
library(DALEXtra)          # for extension of DALEX
library(patchwork)         # for combining plots nicely
```

```{r data}
data("lending_club")
```


## Put it on GitHub!

[Here](https://github.com/alexdenzler/STAT494_site_Denzler) is my GitHub link.

## Modeling

We’ll be using the `lending_club` dataset from the `modeldata` library, which is part of `tidymodels`. The outcome we are interested in predicting is `Class`. And according to the dataset’s help page, its values are “either ‘good’ (meaning that the loan was fully paid back or currently on-time) or ‘bad’ (charged off, defaulted, of 21-120 days late)”. 

### **Tasks**

(@) Explore the data, concentrating on examining distributions of variables and examining missing values.

```{r}
lending_club %>% 
  ggplot(aes(x = funded_amnt)) +
  geom_density() + 
  facet_wrap(vars(Class))
```

```{r}
lending_club %>% 
  ggplot(aes(x = int_rate)) +
  geom_density() + 
  facet_wrap(vars(Class))
```

```{r}
lending_club %>% 
  ggplot(aes(x = annual_inc)) +
  geom_density() + 
  facet_wrap(vars(Class))
```


```{r}
lending_club %>% 
  ggplot(aes(x = addr_state, fill = Class)) +
  geom_bar(position = "fill")
```

```{r}
lending_club %>% 
  count(Class)
```
```{r}
lending_club %>% 
  group_by(addr_state) %>% 
  summarize(count = n()) %>% 
  arrange(desc(count))
```



(@) Do any data cleaning steps that need to happen before the model is build. For example, you might remove any variables that mean the same thing as the response variable (not sure if that happens here), get rid of rows where all variables have missing values, etc.

```{r}
create_more_bad <- lending_club %>% 
  filter(Class == "bad") %>% 
  sample_n(size = 3000, replace = TRUE)

lending_club_mod <- lending_club %>% 
  bind_rows(create_more_bad)
```


(@) Split the data into training and test, putting 75% in the training data.

```{r}
set.seed(494) # for reproducability

lending_split <- initial_split(lending_club_mod,
                             prop = 0.75)
lending_train <- training(lending_split)
lending_test  <- testing(lending_split)
```


(@) Set up the recipe and the pre-processing steps to build a lasso model. Some steps you should take:

* Make all integer variables numeric (I’d highly recommend using `step_mutate_at()` or this will be a lot of code). We’ll want to do this for the model interpretation we’ll do later.
* Think about grouping factor variables with many levels.
* Make categorical variables dummy variables (make sure NOT to do this to the outcome variable).
* Normalize quantitative variables.


```{r}
lending_recipe <- recipe(Class ~ .,
                         data = lending_train) %>% 
  step_rm(acc_now_delinq, delinq_amnt) %>% 
  step_mutate_at(all_numeric(.),
                 fn = ~as.numeric(.)) %>% 
  step_mutate(verification_status = 
                ifelse(verification_status == "Not_Verified", "Not_Verified", "Verified")) %>% 
  step_mutate(annual_inc,
              fn = case_when(annual_inc <= 9875 ~ 10,
                             annual_inc > 9875 && annual_inc <= 40125 ~ 12,
                             annual_inc > 40125 && annual_inc <= 85525 ~ 22,
                             annual_inc > 85525 && annual_inc <= 163300 ~ 24,
                             annual_inc > 163300 && annual_inc <= 207350 ~ 32,
                             annual_inc > 207350 && annual_inc <= 518400 ~ 35,
                             annual_inc > 518400 ~ 37)) %>% 
  step_mutate(annual_inc, fn = ~as.factor(annual_inc)) %>% 
  step_normalize(all_numeric()) %>% 
  step_dummy(all_nominal(), -all_outcomes())
```









